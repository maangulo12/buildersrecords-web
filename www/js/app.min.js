(function() {
    'use strict';

    angular.module('app', [
        /* Vendor modules */
        'ngMessages',
        'ui.validate',
        'ui.router',
        'angular-jwt',
        'angular-storage',
        'smart-table',
        /* App directives */
        'app.directive.email-availability',
        'app.directive.format',
        'app.directive.page-select',
        'app.directive.username-availability',
        /* App services */
        'app.service.auth',
        'app.service.category',
        'app.service.chart',
        'app.service.draw',
        'app.service.expenditure',
        'app.service.fund',
        'app.service.item',
        'app.service.project',
        'app.service.stripe',
        'app.service.subcontractor',
        'app.service.user',
        'app.service.utility',
        /* App modules */
        'app.home',
        'app.login',
        'app.signup',
        'app.tutorial',
        'app.projects',
        'app.projects.overview',
        'app.projects.budget',
        'app.projects.funds',
        'app.projects.expenditures',
        'app.projects.subcontractors',
        'app.account',
        'app.account.billing'
    ]);
})();

(function() {
    'use strict';

    angular
        .module('app')
        .config(config);

    config.$inject = ['$urlRouterProvider', '$locationProvider', 'jwtInterceptorProvider', '$httpProvider'];

    function config($urlRouterProvider, $locationProvider, jwtInterceptorProvider, $httpProvider) {
        // Route to '/' if url not found
        $urlRouterProvider.otherwise('/');
        // Turn on html5mode
        $locationProvider.html5Mode(true);
        // Adds the JSON token to the header of every request
        jwtInterceptorProvider.tokenGetter = function(store) {
            return store.get('jwt');
        };
        $httpProvider.interceptors.push('jwtInterceptor');
    }
})();

(function() {
    'use strict';

    angular
        .module('app')
        .run(runBlock);

    runBlock.$inject = ['$rootScope', '$state', 'store', 'jwtHelper'];

    function runBlock($rootScope, $state, store, jwtHelper) {
        // CHANGE THESE FOR PRODUCTION DEPLOYMENT
        store.set('url', 'https://buildersrecords-api-staging.herokuapp.com');
        Stripe.setPublishableKey('pk_test_KY3H8e295UxwoHrrqHBobKRC');
        // Restricts access to routes that require login
        $rootScope.$on('$stateChangeStart', change);
        function change(e, to) {
            if (to.data && to.data.requiresLogin) {
                if (!store.get('jwt') || jwtHelper.isTokenExpired(store.get('jwt'))) {
                    e.preventDefault();
                    $state.go('login');
                }
            }
        }
    }
})();

(function() {
    'use strict';

    angular.module('app.account', []);
})();

(function() {
    'use strict';

    angular.module('app.account.billing', []);
})();

(function() {
    'use strict';

    angular.module('app.projects.budget', []);
})();

(function() {
    'use strict';

    angular.module('app.projects.expenditures', []);
})();

(function() {
    'use strict';

    angular.module('app.projects.funds', []);
})();

(function() {
    'use strict';

    angular.module('app.home', []);
})();

(function() {
    'use strict';

    angular.module('app.login', []);
})();

(function() {
    'use strict';

    angular.module('app.projects.overview', []);
})();

(function() {
    'use strict';

    angular.module('app.projects', []);
})();

(function() {
    'use strict';

    angular.module('app.projects.subcontractors', []);
})();

(function() {
    'use strict';

    angular.module('app.signup', []);
})();

(function() {
    'use strict';

    angular.module('app.tutorial', []);
})();

(function() {
    'use strict';

    /**
    * @desc checks if an email address already exists
    * @example <input ng-model="myModel" email-availability></input>
    */
    angular
        .module('app.directive.email-availability', [])
        .directive('emailAvailability', emailAvailability);

    emailAvailability.$inject = ['$q', 'utilityService'];

    function emailAvailability($q, utilityService) {
        var directive = {
            restrict: 'A',
            require:  'ngModel',
            link:     linkFunc,
        };
        return directive;

        function linkFunc(scope, el, attr, ctrl) {
            ctrl.$asyncValidators.emailAvailability = function(email) {
                return verifyEmail(email)
                    .then(success)
                    .catch(error);

                function verifyEmail(email) {
                    return utilityService.verifyEmail(email);
                }
                function success(response) {
                    ctrl.$setValidity('emailAvailability', true);
                    return $q.resolve(response);
                }
                function error(response) {
                    ctrl.$setValidity('emailAvailability', false);
                    return $q.reject(response);
                }
            };
        }
    }
})();

(function() {
    'use strict';

    /**
    * @desc formats an input number field with commas
    * @example <input ng-model="myModel" format="number"></input>
    */
    angular
        .module('app.directive.format', [])
        .directive('format', format);

    format.$inject = ['$filter'];

    function format($filter) {
        var directive = {
            restrict: 'A',
            require:  'ngModel',
            link:     linkFunc,
        };
        return directive;

        function linkFunc(scope, el, attr, ctrl) {
            ctrl.$formatters.unshift(formatter);
            ctrl.$parsers.unshift(parser);

            function formatter(a) {
                return $filter(attr.format)(ctrl.$modelValue);
            }
            function parser(viewValue) {
                var plainNumber = viewValue.replace(/[^\d|\-+|\.+]/g, '');
                el.val($filter(attr.format)(plainNumber));
                return plainNumber;
            }
        }
    }
})();

(function() {
    'use strict';

    /**
    * @desc Smart-table custom pagination
    * @example <page-select></page-select>
    */
    angular
        .module('app.directive.page-select', [])
        .directive('pageSelect', pageSelect);

    function pageSelect() {
        var directive = {
            restrict: 'E',
            template: '<input type="text" class="select-page" ng-model="inputPage" ng-change="selectPage(inputPage)">',
            link:     linkFunc,
        };
        return directive;

        function linkFunc(scope, el, attr, ctrl) {
            scope.$watch('currentPage', function(c) {
                scope.inputPage = c;
            });
        }
    }
})();

(function() {
    'use strict';

    /**
    * @desc checks if a username already exists
    * @example <input ng-model="myModel" username-availability></input>
    */
    angular
        .module('app.directive.username-availability', [])
        .directive('usernameAvailability', usernameAvailability);

    usernameAvailability.$inject = ['$q', 'utilityService'];

    function usernameAvailability($q, utilityService) {
        var directive = {
            restrict: 'A',
            require:  'ngModel',
            link:     linkFunc,
        };
        return directive;

        function linkFunc(scope, el, attr, ctrl) {
            ctrl.$asyncValidators.usernameAvailability = function(username) {
                return verifyUsername(username)
                    .then(success)
                    .catch(error);

                function verifyUsername(username) {
                    return utilityService.verifyUsername(username);
                }
                function success(response) {
                    ctrl.$setValidity('usernameAvailability', true);
                    return $q.resolve(response);
                }
                function error(response) {
                    ctrl.$setValidity('usernameAvailability', false);
                    return $q.reject(response);
                }
            };
        }
    }
})();

(function() {
    'use strict';

    angular
        .module('app.service.auth', [])
        .factory('authService', authService);

    authService.$inject = ['$http', 'store', 'jwtHelper', '$q'];

    function authService($http, store, jwtHelper, $q) {
        var url = store.get('url') + '/api/auth';
        var service = {
            authenticate: authenticate
        };
        return service;

        function authenticate(login, password) {
            var data = {
                login:    login,
                password: password
            };
            return $http.post(url, data)
                .then(success)
                .catch(error);

            function success(response) {
                var token   = response.data.token;
                var payload = jwtHelper.decodeToken(token);
                var user    = {
                    id:     payload.user_id,
                    stripe: payload.stripe_id
                };
                store.set('jwt', token);
                store.set('user', user);
                return $q.resolve(response);
            }
            function error(response) {
                return $q.reject(response);
            }
        }
    }
})();

(function() {
    'use strict';

    angular
        .module('app.service.category', [])
        .factory('categoryService', categoryService);

    categoryService.$inject = ['$http', 'store', '$q'];

    function categoryService($http, store, $q) {
        var url = store.get('url') + '/api/categories';
        var service = {
            retrieveList: retrieveList,
            create:       create,
            update:       update,
            remove:       remove
        };
        return service;

        function retrieveList() {
			return $http.get(url + query('project_id', 'equals', store.get('project').id))
                .then(success)
                .catch(error);
        }

        function create(name) {
            var data = {
                name:       name,
                project_id: store.get('project').id
            };
            return $http.post(url, data)
                .then(success)
                .catch(error);
        }

        function update(name) {
            var data = {
                name:       name,
                project_id: store.get('project').id
            };
            return $http.put(url + '/' + store.get('category').id, data)
                .then(success)
                .catch(error);
        }

        function remove() {
            return $http.delete(url + '/' + store.get('category').id)
                .then(success)
                .catch(error);
        }

        // Helpers
        function success(response) {
            return $q.resolve(response);
        }
        function error(response) {
            return $q.reject(response);
        }
        function query(name, op, val) {
            return '?q={"filters":[{"name":"' + name + '","op":"' + op + '","val":"' + val + '"}]}';
        }
    }
})();

(function() {
    'use strict';

    angular
        .module('app.service.chart', [])
        .factory('chartService', chartService);

    function chartService() {
        var service = {
            setPieChartOptions: setPieChartOptions
        };
        return service;

        function setPieChartOptions() {
            return {
	            chart: {
	                type: 'pie',
	                style: {
	                    fontFamily: "Montserrat, 'Helvetica Neue', Helvetica, Arial, sans-serif"
	                }
	            },
	            title: {
	                text: ''
	            },
	            tooltip: {
	                headerFormat: '<span style="font-size: 14px"> {point.key} </span><br>',
	                pointFormat:  '<span style="font-size: 14px"> <b> ${point.y:.2f} </b> </span><br>'
	            },
	            plotOptions: {
	                pie: {
	                    allowPointSelect: true,
	                    cursor: 'pointer',
	                    dataLabels: {
	                        enabled: true,
	                        format: '<span style="font-size: 11px"> {point.name} </span><br> {point.percentage:.2f}%'
	                    }
	                }
	            },
	            series: [{
	                name: 'Categories',
	                data: []
	            }],
	            credits: {
	                enabled: false
	            }
	        };
        }
    }
})();

(function() {
    'use strict';

    angular
        .module('app.service.draw', [])
        .factory('drawService', drawService);

    drawService.$inject = ['$http', 'store', '$q'];

    function drawService($http, store, $q) {
        var url = store.get('url') + '/api/draws';
        var service = {
            create:       create,
            update:       update,
            remove:       remove,
            removeByFund: removeByFund
        };
        return service;

        function create(draw) {
            var data = {
                date:    draw.date,
                amount:  draw.amount,
                fund_id: store.get('fund').id
            };
            return $http.post(url, data)
                .then(success)
                .catch(error);
        }

        function update(draw) {
            var data = {
                date:    draw.date,
                amount:  draw.amount,
                fund_id: store.get('fund').id
            };
            return $http.put(url + '/' + store.get('draw').id, data)
                .then(success)
                .catch(error);
        }

        function remove(drawId) {
            return $http.delete(url + '/' + drawId)
                .then(success)
                .catch(error);
        }

        function removeByFund() {
            return $http.delete(url + query('fund_id', 'equals', store.get('fund').id))
                .then(success)
                .catch(error);
        }

        // Helpers
        function success(response) {
            return $q.resolve(response);
        }
        function error(response) {
            return $q.reject(response);
        }
        function query(name, op, val) {
            return '?q={"filters":[{"name":"' + name + '","op":"' + op + '","val":"' + val + '"}]}';
        }
    }
})();

(function() {
    'use strict';

    angular
        .module('app.service.expenditure', [])
        .factory('expenditureService', expenditureService);

    expenditureService.$inject = ['$http', 'store', '$q', '$filter'];

    function expenditureService($http, store, $q, $filter) {
        var url = store.get('url') + '/api/expenditures';
        var service = {
            retrieveList:       retrieveList,
            create:             create,
            update:             update,
            remove:             remove,
            retrieveByCategory: retrieveByCategory,
            removeByCategory:   removeByCategory
        };
        return service;

        function retrieveList() {
            return $http.get(url + query('project_id', 'equals', store.get('project').id))
                .then(success)
                .catch(error);
        }

        function create(expenditure) {
            var data = {
                date:        $filter('date')(expenditure.date,'yyyy-MM-dd'),
                vendor:      expenditure.vendor,
                notes:       expenditure.notes,
                cost:        expenditure.cost,
                fund_id:     expenditure.fund.id,
                category_id: expenditure.item.category.id,
                item_id:     expenditure.item.id,
                project_id:  store.get('project').id
            };
            return $http.post(url, data)
                .then(success)
                .catch(error);
        }

        function update(expenditure) {
            var data = {
                date:        $filter('date')(expenditure.date,'yyyy-MM-dd'),
                vendor:      expenditure.vendor,
                notes:       expenditure.notes,
                cost:        expenditure.cost,
                fund_id:     expenditure.fund.id,
                category_id: expenditure.item.category.id,
                item_id:     expenditure.item.id,
                project_id:  store.get('project').id
            };
            return $http.put(url + '/' + store.get('expenditure').id, data)
                .then(success)
                .catch(error);
        }

        function remove(expenditureId) {
            return $http.delete(url + '/' + expenditureId)
                .then(success)
                .catch(error);
        }

        function retrieveByCategory() {
			return $http.get(url + query('category_id', 'equals', store.get('category').id))
                .then(success)
                .catch(error);
        }

        function removeByCategory() {
            return $http.delete(url + query('category_id', 'equals', store.get('category').id))
                .then(success)
                .catch(error);
        }

        // Helpers
        function success(response) {
            return $q.resolve(response);
        }
        function error(response) {
            return $q.reject(response);
        }
        function query(name, op, val) {
            return '?q={"filters":[{"name":"' + name + '","op":"' + op + '","val":"' + val + '"}]}';
        }
    }
})();

(function() {
    'use strict';

    angular
        .module('app.service.fund', [])
        .factory('fundService', fundService);

    fundService.$inject = ['$http', 'store', '$q'];

    function fundService($http, store, $q) {
        var url = store.get('url') + '/api/funds';
        var service = {
            retrieveList: retrieveList,
            create:       create,
            update:       update,
            remove:       remove
        };
        return service;

        function retrieveList() {
			return $http.get(url + query('project_id', 'equals', store.get('project').id))
                .then(success)
                .catch(error);
        }

        function create(fund) {
            var data = {
                name:       fund.name,
                loan:       fund.loan,
                amount:     fund.amount,
                project_id: store.get('project').id
            };
            return $http.post(url, data)
                .then(success)
                .catch(error);
        }

        function update(fund) {
            var data = {
                name:       fund.name,
                amount:     fund.amount,
                project_id: store.get('project').id
            };
            return $http.put(url + '/' + store.get('fund').id, data)
                .then(success)
                .catch(error);
        }

        function remove() {
            return $http.delete(url + '/' + store.get('fund').id)
                .then(success)
                .catch(error);
        }

        // Helpers
        function success(response) {
            return $q.resolve(response);
        }
        function error(response) {
            return $q.reject(response);
        }
        function query(name, op, val) {
            return '?q={"filters":[{"name":"' + name + '","op":"' + op + '","val":"' + val + '"}]}';
        }
    }
})();

(function() {
    'use strict';

    angular
        .module('app.service.item', [])
        .factory('itemService', itemService);

    itemService.$inject = ['$http', 'store', '$q'];

    function itemService($http, store, $q) {
        var url = store.get('url') + '/api/items';
        var service = {
            retrieveList:       retrieveList,
            create:             create,
            update:             update,
            remove:             remove,
            retrieveByCategory: retrieveByCategory,
            removeByCategory:   removeByCategory
        };
        return service;

        function retrieveList() {
            return $http.get(url + query('project_id', 'equals', store.get('project').id))
                .then(success)
                .catch(error);
        }

        function create(item) {
            var data = {
                name:        item.name,
                description: item.description,
                estimated:   item.estimated,
                actual:      item.actual,
                category_id: item.category,
                project_id:  store.get('project').id
            };
            return $http.post(url, data)
                .then(success)
                .catch(error);
        }

        function update(item) {
            var data = {
                name:        item.name,
                description: item.description,
                estimated:   item.estimated,
                actual:      item.actual,
                category_id: item.category.id,
                project_id:  store.get('project').id
            };
            return $http.put(url + '/' + store.get('item').id, data)
                .then(success)
                .catch(error);
        }

        function remove(itemId) {
            return $http.delete(url + '/' + itemId)
                .then(success)
                .catch(error);
        }

        function retrieveByCategory() {
            return $http.get(url + query('category_id', 'equals', store.get('category').id))
                .then(success)
                .catch(error);
        }

        function removeByCategory() {
            return $http.delete(url + query('category_id', 'equals', store.get('category').id))
                .then(success)
                .catch(error);
        }

        // Helpers
        function success(response) {
            return $q.resolve(response);
        }
        function error(response) {
            return $q.reject(response);
        }
        function query(name, op, val) {
            return '?q={"filters":[{"name":"' + name + '","op":"' + op + '","val":"' + val + '"}]}';
        }
    }
})();

(function() {
    'use strict';

    angular
        .module('app.service.project', [])
        .factory('projectService', projectService);

    projectService.$inject = ['$http', 'store', '$q'];

    function projectService($http, store, $q) {
        var url = store.get('url') + '/api/projects';
        var service = {
            retrieveList: retrieveList,
            create:       create,
            update:       update,
            remove:       remove
        };
        return service;

        function retrieveList() {
            return $http.get(url + query('user_id', 'equals', store.get('user').id))
                .then(success)
                .catch(error);
        }

        function create(project) {
            var data = {
                name:         project.name,
                address:      project.address,
                city:         project.city,
                state:        project.state,
                zipcode:      project.zipcode,
                home_sq:      project.homeSq,
                project_type: project.type,
                user_id:      store.get('user').id
            };
            return $http.post(url, data)
                .then(success)
                .catch(error);
        }

        function update(project) {
            var data = {
                name:    project.name,
                address: project.address,
                city:    project.city,
                state:   project.state,
                zipcode: project.zipcode,
                home_sq: project.homeSq,
                user_id: store.get('user').id
            };
            return $http.put(url + '/' + project.id, data)
                .then(success)
                .catch(error);
        }

        function remove(project) {
            return $http.delete(url + '/' + project.id)
                .then(success)
                .catch(error);
        }

        // Helpers
        function success(response) {
            return $q.resolve(response);
        }
        function error(response) {
            return $q.reject(response);
        }
        function query(name, op, val) {
            return '?q={"filters":[{"name":"' + name + '","op":"' + op + '","val":"' + val + '"}]}';
        }
    }
})();

(function() {
    'use strict';

    angular
        .module('app.service.stripe', [])
        .factory('stripeService', stripeService);

    stripeService.$inject = ['$http', 'store', '$q'];

    function stripeService($http, store, $q) {
        var url = store.get('url') + '/api/stripe';
        var service = {
            validateCard:         validateCard,
            createCardToken:      createCardToken,
            createSubscription:   createSubscription,
            retrieveSubscription: retrieveSubscription,
            updateSubscription:   updateSubscription
        };
        return service;

        function validateCard(card) {
            var num = Stripe.card.validateCardNumber(card.cardNumber);
            var exp = Stripe.card.validateExpiry(card.expMonth, card.expYear);
            var cvc = Stripe.card.validateCVC(card.cvc);

            if (num && exp && cvc) {
                return true;
            }
            else {
                return false;
            }
        }

        function createCardToken(card) {
            var data = {
                number:    card.cardNumber,
                cvc:       card.cvc,
                exp_month: card.expMonth,
                exp_year:  card.expYear,
                name:      card.cardName.toUpperCase()
            };
            return $q(function(resolve, reject) {
                Stripe.card.createToken(data, responseCallback);

                function responseCallback(status, response) {
                    if (response.error) {
                        return reject(response);
                    } else {
                        return resolve(response);
                    }
                }
            });
        }

        function createSubscription(user, tokenId) {
            var data = {
                email:    user.email,
                username: user.username,
                password: user.password,
                plan:     user.plan,
                token_id: tokenId
            };
            return $http.post(url, data)
                .then(success)
                .catch(error);
        }

        function retrieveSubscription() {
            return $http.get(url + '/' + store.get('user').stripe)
                .then(success)
                .catch(error);
        }

        function updateSubscription(tokenId) {
            var data = {
                stripe_id: store.get('user').stripe,
                token_id:  tokenId
            };
            return $http.put(url + '/' + store.get('user').stripe, data)
                .then(success)
                .catch(error);
        }

        // Helpers
        function success(response) {
            return $q.resolve(response);
        }
        function error(response) {
            return $q.reject(response);
        }
    }
})();

(function() {
    'use strict';

    angular
        .module('app.service.subcontractor', [])
        .factory('subcontractorService', subcontractorService);

    subcontractorService.$inject = ['$http', 'store', '$q'];

    function subcontractorService($http, store, $q) {
        var url = store.get('url') + '/api/subcontractors';
        var service = {
            retrieveList: retrieveList,
            create:       create,
            update:       update,
            remove:       remove
        };
        return service;

        function retrieveList() {
            return $http.get(url + query('project_id', 'equals', store.get('project').id))
                .then(success)
                .catch(error);
        }

        function create(subcontractor) {
            var data = {
                name:           subcontractor.name,
                company:        subcontractor.company,
                contact_number: subcontractor.contactNumber,
                project_id:     store.get('project').id
            };
            return $http.post(url, data)
                .then(success)
                .catch(error);
        }

        function update(subcontractor) {
            var data = {
                name:           subcontractor.name,
                company:        subcontractor.company,
                contact_number: subcontractor.contactNumber,
                project_id:     store.get('project').id
            };
            return $http.put(url + '/' + subcontractor.id, data)
                .then(success)
                .catch(error);
        }

        function remove(subcontractor) {
            console.log(subcontractor.id);
            return $http.delete(url + '/' + subcontractor.id)
                .then(success)
                .catch(error);
        }

        // Helpers
        function success(response) {
            return $q.resolve(response);
        }
        function error(response) {
            return $q.reject(response);
        }
        function query(name, op, val) {
            return '?q={"filters":[{"name":"' + name + '","op":"' + op + '","val":"' + val + '"}]}';
        }
    }
})();

(function() {
    'use strict';

    angular
        .module('app.service.user', [])
        .factory('userService', userService);

    userService.$inject = ['$http', 'store', '$q'];

    function userService($http, store, $q) {
        var url = store.get('url') + '/api/users';
        var service = {
            retrieve:       retrieve,
            updateUser:     updateUser,
            updatePassword: updatePassword
        };
        return service;

        function retrieve() {
            return $http.get(url + '/' + store.get('user').id)
                .then(success)
                .catch(error);
        }

        function updateUser(user) {
            var data = {
                email:    user.email,
                username: user.username
            };
            return $http.put(url + '/' + store.get('user').id, data)
                .then(success)
                .catch(error);
        }

        function updatePassword(password) {
            return $http.put(url + '/' + store.get('user').id, { password: password })
                .then(success)
                .catch(error);
        }

        // Helpers
        function success(response) {
            return $q.resolve(response);
        }
        function error(response) {
            return $q.reject(response);
        }
    }
})();

(function() {
    'use strict';

    angular
        .module('app.service.utility', [])
        .factory('utilityService', utilityService);

    utilityService.$inject = ['$http', 'store', '$q'];

    function utilityService($http, store, $q) {
        var url = store.get('url') + '/api/utility';
        var service = {
            verifyEmail:       verifyEmail,
            verifyUsername:    verifyUsername,
            parseUbuilditFile: parseUbuilditFile
        };
        return service;

        function verifyEmail(email) {
            return $http.post(url + '/email', { email : email })
                .then(success)
                .catch(error);
        }

        function verifyUsername(username) {
            return $http.post(url + '/username', { username : username })
                .then(success)
                .catch(error);
        }

        function parseUbuilditFile(vm, file) {
            var data = new FormData();
            data.append('file', file);
            data.append('name', vm.name);
            data.append('address', vm.address);
            data.append('city', vm.city);
            data.append('state', vm.state);
            data.append('zipcode', vm.zipcode);
            data.append('home_sq', vm.homeSq);
            data.append('project_type', vm.type);
            data.append('user_id', store.get('user').id);

            var config = {
                transformRequest: angular.identity,
                headers: { 'Content-Type': undefined }
            };
            return $http.post(url + '/ubuildit', data, config)
                .then(success)
                .catch(error);
        }

        // Helpers
        function success(response) {
            return $q.resolve(response);
        }
        function error(response) {
            return $q.reject(response);
        }
    }
})();

(function() {
    'use strict';

    angular
        .module('app.account')
        .controller('AccountController', AccountController);

    AccountController.$inject = ['$scope', 'User', 'userService'];

    function AccountController($scope, User, userService) {
        var vm = this;
        vm.account = {};
        vm.account.email = User.email;
        vm.account.username = User.username;

        // Needs work
        // Change email in Stripe
        $scope.updateAccount = function() {
            var btn = $('#update-account-button').button('loading');

            updateAccount()
                .then(updateSuccess)
                .catch(error);

            function updateAccount() {
                return userService.updateUser(vm.account);
            }
            function updateSuccess(response) {
                vm.updateAccountSuccess = true;
                btn.button('reset');
            }
            function error() {
                $scope.accountForm.$invalid = true;
                vm.updateAccountError = true;
                btn.button('reset');
            }
        };

        // Needs work
        // Check if current password matches
        // Hash new password in the backend
        $scope.updatePassword = function() {
            var btn = $('#update-password-button').button('loading');

            updatePassword()
                .then(updateSuccess)
                .catch(error);

            function updatePassword() {
                return userService.updatePassword(vm.account.newPassword);
            }
            function updateSuccess(response) {
                vm.updatePasswordSuccess = true;
                btn.button('reset');
            }
            function error(response) {
                $scope.passwordForm.$invalid = true;
                vm.updatePasswordError = true;
                btn.button('reset');
            }
        };
    }
})();

(function() {
    'use strict';

    angular
        .module('app.account')
        .config(route);

    route.$inject = ['$stateProvider'];

    function route($stateProvider) {
        $stateProvider.state('account', {
            url: '/account',
            resolve: {
                User: ["userService", "$q", function(userService, $q) {
                    return userService.retrieve()
                        .then(responseHandler)
                        .catch(errorHandler);

                    function responseHandler(response) {
                        return response.data;
                    }
                    function errorHandler(response) {
                        return $q.reject(response.data);
                    }
                }]
            },
            views: {
                'nav': {
                    templateUrl: 'www/templates/nav2.html',
                    controller: ["$scope", "User", function($scope, User) {
                        $scope.username = User.username;
                    }]
                },
                'body': {
                    templateUrl:  'www/templates/account.html',
                    controller:   'AccountController',
                    controllerAs: 'vm'
                }
            },
            data: {
                requiresLogin: true
            }
        });
    }
})();

(function() {
    'use strict';

    angular
        .module('app.account.billing')
        .controller('BillingController', BillingController);

    BillingController.$inject = ['$scope', 'stripeService'];

    function BillingController($scope, stripeService) {
        var vm = this;
        getSubscription();

        function getSubscription() {
            return stripeService.retrieveSubscription()
                .then(showSubscription)
                .catch(error);

            function showSubscription(response) {
                vm.card = {};
                vm.card.name  = response.data.sources.data[0].name;
                vm.card.last4 = response.data.sources.data[0].last4;
                vm.card.brand = response.data.sources.data[0].brand;
                vm.plan       = response.data.subscriptions.data[0].plan.id;
            }
            function error(response) {
                vm.errorMsgGet = true;
            }
        }

        $scope.showUpdateCardModal = function() {
            vm.updatedCard = {};
            $scope.editCardForm.$setPristine();
            $('#edit-card-modal').modal('show');
        };
        $scope.updateCard = function() {
            var btn = $('#update-card-button').button('loading');
            var valid = stripeService.validateCard(vm.updatedCard);

            if (valid) {
                createToken()
                    .then(updateSubscription)
                    .then(updateSuccess)
                    .catch(error);
            } else {
                error();
            }

            function createToken() {
                return stripeService.createCardToken(vm.updatedCard);
            }
            function updateSubscription(response) {
                return stripeService.updateSubscription(response.id);
            }
            function updateSuccess(response) {
                $('#edit-card-modal').modal('hide');
                btn.button('reset');
                getSubscription();
            }
            function error() {
                $scope.editCardForm.$invalid = true;
                btn.button('reset');
            }
        };
    }
})();

(function() {
    'use strict';

    angular
        .module('app.account.billing')
        .config(route);

    route.$inject = ['$stateProvider'];

    function route($stateProvider) {
        $stateProvider.state('billing', {
            url: '/account/billing',
            resolve: {
                User: ["userService", "$q", function(userService, $q) {
                    return userService.retrieve()
                        .then(responseHandler)
                        .catch(errorHandler);

                    function responseHandler(response) {
                        return response.data;
                    }
                    function errorHandler(response) {
                        return $q.reject(response.data);
                    }
                }]
            },
            views: {
                'nav': {
                    templateUrl: 'www/templates/nav2.html',
                    controller: ["$scope", "User", function($scope, User) {
                        $scope.username = User.username;
                    }]
                },
                'body': {
                    templateUrl:  'www/templates/billing.html',
                    controller:   'BillingController',
                    controllerAs: 'vm'
                }
            },
            data: {
                requiresLogin: true
            }
        });
    }
})();

(function() {
    'use strict';

    angular
        .module('app.projects.budget')
        .controller('BudgetController', BudgetController);

    BudgetController.$inject = ['$scope', 'store', 'categoryService', 'itemService', 'expenditureService'];

    function BudgetController($scope, store, categoryService, itemService, expenditureService) {
        var vm = this;
        vm.project = store.get('project');
        updateCategories();

        // GET function
        function updateCategories() {
            return getCategories()
                .then(populateTable)
                .catch(error);

            function getCategories() {
                return categoryService.retrieveList()
                    .then(success);

                function success(response) {
                    vm.categoryList = response.data.objects;
                    return vm.categoryList;
                }
            }
            function populateTable() {
                var grandTotalEstimated = 0;
                var grandTotalActual    = 0;

                angular.forEach(vm.categoryList, function(category) {
                    var totalEstimated = 0;
                    var totalActual    = 0;
                    angular.forEach(category.items, function(item) {
                        totalEstimated += item.estimated;
                        totalActual    += item.actual;
                    });
                    category.totalEstimated = totalEstimated;
                    category.totalActual    = totalActual;
                    grandTotalEstimated += totalEstimated;
                    grandTotalActual    += totalActual;
                });
                vm.grandTotalEstimated = grandTotalEstimated;
                vm.grandTotalActual    = grandTotalActual;
            }
            function error(response) {
                vm.getError = true;
            }
        }

        // CLICKED functions
        $scope.clickedItem = function(item) {
            var index = store.get('category').items.indexOf(item);
            if (index !== -1) {
                store.set('item', item);
                return true;
            }
            return false;
        };
        $scope.clickedSingleCheckbox = function(category, item) {
            if (item.selected) {
                vm.selected = true;
            } else {
                var isSelected = false;
                angular.forEach(category.items, function(e) {
                    if (e.selected) {
                        isSelected = true;
                    }
                });
                vm.selected = isSelected;
            }
        };
        $scope.clickedCategory = function(category) {
            var index = vm.categoryList.indexOf(category);
            if (index !== -1) {
                store.set('category', category);
                return true;
            }
            return false;
        };

        // ADD Item functions
        $scope.showAddItemModal = function() {
            vm.item           = {};
            vm.item.estimated = 0;
            vm.item.actual    = 0;
            $scope.addItemForm.$setPristine();
            $('#add-item-modal').modal('show');
        };
        $scope.addItem = function() {
            var btn = $('#add-item-button').button('loading');

            if (vm.item.newCategory) {
                addCategory()
                    .then(setNewCategory)
                    .then(addItem)
                    .then(addSuccess)
                    .catch(error);
            } else {
                addItem()
                    .then(addSuccess)
                    .catch(error);
            }

            function addCategory() {
                return categoryService.create(vm.item.newCategory);
            }
            function setNewCategory(data) {
                vm.item.category = data.id;
            }
            function addItem() {
                return itemService.create(vm.item);
            }
            function addSuccess() {
                $('#add-item-modal').modal('hide');
                btn.button('reset');
                updateCategories();
            }
            function error() {
                $scope.addItemForm.$invalid = true;
                btn.button('reset');
            }
        };

        // DELETE MANY Items functions
        $scope.showDeleteItemsModal = function() {
            if (!$('#delete-button').hasClass('disabled')) {
                vm.errorMsgDeleteItems = false;
                $('#delete-items-modal').modal('show');
            }
        };
        $scope.deleteItems = function() {
            var btn = $('#delete-items-button').button('loading');

            angular.forEach(vm.categoryList, function(category) {
                angular.forEach(category.items, function(item) {
                    if (item.selected) {
                        deleteItem(item.id)
                            .then(deleteSuccess)
                            .catch(error);
                    }
                });
            });

            function deleteItem(itemId) {
                return itemService.remove(itemId);
            }
            function deleteSuccess() {
                $('#delete-items-modal').modal('hide');
                btn.button('reset');
                vm.selected = false;
                updateCategories();
            }
            function error() {
                vm.errorMsgDeleteItems = true;
                btn.button('reset');
            }
        };

        // DELETE Item functions
        $scope.showDeleteItemModal = function() {
            vm.errorMsgDeleteItem = false;
            $('#delete-item-modal').modal('show');
        };
        $scope.deleteItem = function() {
            var btn = $('#delete-item-button').button('loading');

            deleteItem()
                .then(deleteSuccess)
                .catch(error);

            function deleteItem() {
                return itemService.remove(store.get('item').id);
            }
            function deleteSuccess() {
                $('#delete-item-modal').modal('hide');
                btn.button('reset');
                updateCategories();
            }
            function error() {
                vm.errorMsgDeleteItem = true;
                btn.button('reset');
            }
        };

        // UPDATE Item functions
        $scope.showEditItemModal = function() {
            vm.updatedItem             = {};
            vm.updatedItem.category    = {
                id:   store.get('category').id,
                name: store.get('category').name
            };
            vm.updatedItem.name        = store.get('item').name;
            vm.updatedItem.description = store.get('item').description;
            vm.updatedItem.estimated   = store.get('item').estimated;
            vm.updatedItem.actual      = store.get('item').actual;
            $scope.editItemForm.$setPristine();
            $('#edit-item-modal').modal('show');
        };
        $scope.updateItem = function() {
            var btn = $('#update-item-button').button('loading');

            updateItem()
                .then(updateSuccess)
                .catch(error);

            function updateItem() {
                return itemService.update(vm.updatedItem);
            }
            function updateSuccess() {
                $('#edit-item-modal').modal('hide');
                btn.button('reset');
                updateCategories();
            }
            function error() {
                $scope.editItemForm.$invalid = true;
                btn.button('reset');
            }
        };

        // DELETE Category functions
        $scope.showDeleteCategoryModal = function() {
            vm.errorMsgDeleteCategory = false;
            $('#delete-category-modal').modal('show');
        };
        $scope.deleteCategory = function() {
            var btn = $('#delete-category-button').button('loading');
            var expenditures = 0;
            var items = 0;

            getExpenditures()
                .then(setExpenditures)
                .then(getItems)
                .then(setItems)
                .then(checkCategory)
                .then(deleteSuccess)
                .catch(error);

            function getExpenditures() {
                return expenditureService.retrieveByCategory();
            }
            function setExpenditures(data) {
                console.log(data.num_results);
                expenditures = data.num_results;
            }
            function getItems() {
                return itemService.retrieveByCategory();
            }
            function setItems(data) {
                console.log(data.num_results);
                items = data.num_results;
            }
            function checkCategory() {
                if (expenditures === 0 && items === 0) {
                    return deleteCategory();
                }
                else if (expenditures !== 0 && items !== 0) {
                    return deleteExpenditures()
                        .then(deleteItems)
                        .then(deleteCategory);
                }
                else if (expenditures !== 0 && items === 0) {
                    return deleteExpenditures()
                        .then(deleteCategory);
                }
                else {
                    console.log('MADE IT');
                    return deleteItems()
                        .then(deleteCategory);
                }
            }
            function deleteExpenditures() {
                return expenditureService.removeByCategory();
            }
            function deleteItems() {
                return itemService.removeByCategory();
            }
            function deleteCategory() {
                return categoryService.remove();
            }
            function deleteSuccess() {
                $('#delete-category-modal').modal('hide');
                btn.button('reset');
                updateCategories();
            }
            function error() {
                vm.errorMsgDeleteCategory = true;
                btn.button('reset');
            }
        };

        // UPDATE Category functions
        $scope.showEditCategoryModal = function() {
            vm.category = {};
            vm.category.name = store.get('category').name;
            $scope.editCategoryForm.$setPristine();
            $('#edit-category-modal').modal('show');
        };
        $scope.updateCategory = function() {
            var btn = $('#update-category-button').button('loading');

            updateCategory()
                .then(updateSuccess)
                .catch(error);

            function updateCategory() {
                return categoryService.update(vm.category.name);
            }
            function updateSuccess() {
                $('#edit-category-modal').modal('hide');
                btn.button('reset');
                updateCategories();
            }
            function error() {
                $scope.editCategoryForm.$invalid = true;
                btn.button('reset');
            }
        };
    }
})();

(function() {
    'use strict';

    updateUser.$inject = ["userService", "$q"];
    NavController.$inject = ["User"];
    angular
        .module('app.projects.budget')
        .config(route);

    route.$inject = ['$stateProvider'];

    function route($stateProvider) {
        $stateProvider.state('budget', {
            url: '/projects/budget',
            resolve: {
                User: updateUser
            },
            views: {
                'nav': {
                    templateUrl:  'www/templates/nav2.html',
                    controller:   NavController,
                    controllerAs: 'vm'
                },
                'body': {
                    templateUrl:  'www/templates/budget.html',
                    controller:   'BudgetController',
                    controllerAs: 'vm'
                }
            },
            data: {
                requiresLogin: true
            }
        });
    }

    function updateUser(userService, $q) {
        return getUser()
            .then(success)
            .catch(error);

        function getUser() {
            return userService.retrieve();
        }
        function success(response) {
            return $q.resolve(response.data);
        }
        function error(response) {
            return $q.reject(response);
        }
    }

    function NavController(User) {
        var vm = this;
        vm.username = User.username;
    }
})();

(function() {
    'use strict';

    angular
        .module('app.projects.expenditures')
        .controller('ExpendituresController', ExpendituresController);

    ExpendituresController.$inject = ['$scope', 'store', 'expenditureService', 'subcontractorService', 'itemService', 'fundService'];

    function ExpendituresController($scope, store, expenditureService, subcontractorService, itemService, fundService) {
        var vm = this;
        vm.project = store.get('project');
        updateExpenditures();
        updateSubcontractors();
        updateItems();
        updateFunds();

        // GET Expenditures
        function updateExpenditures() {
            getExpenditures()
                .then(calculateTotal)
                .catch(error);

            function getExpenditures() {
                return expenditureService.retrieveList()
                    .then(success);

                function success(data) {
                    vm.expenditureList = data.objects;
                    return vm.expenditureList;
                }
            }
            function calculateTotal() {
                var total = 0;

                angular.forEach(vm.expenditureList, function(expenditure) {
                    total += expenditure.cost;
                });
                vm.totalCost = total;
            }
            function error() {
                vm.getError = true;
            }
        }

        // GET Subcontractors
        function updateSubcontractors() {
            return getSubcontractors();

            function getSubcontractors() {
                return subcontractorService.retrieveList()
                    .then(success)
                    .catch(error);

                function success(data) {
                    vm.subcontractorList = data.objects;
                    return vm.subcontractorList;
                }
                function error() {
                    vm.getError = true;
                }
            }
        }

        // GET Items
        function updateItems() {
            return getItems()
                .then(populateList)
                .catch(error);

            function getItems() {
                return itemService.retrieveList()
                    .then(success);

                function success(data) {
                    vm.itemList = data.objects;
                    return vm.itemList;
                }
            }
            function populateList() {
                var list = [];
                angular.forEach(vm.itemList, function(item) {
                    list.push({
                        id  : item.id,
                        name: item.name,
                        category: {
                            id  : item.categories.id,
                            name: item.categories.name,
                        }
                    });
                });
                vm.itemList = list;
            }
            function error() {
                vm.getError = true;
            }
        }

        // GET Funds
        function updateFunds() {
            return getFunds()
                .then(populateList)
                .catch(error);

            function getFunds() {
                return fundService.retrieveList()
                    .then(success);

                function success(data) {
                    vm.fundList = data.objects;
                    return vm.fundList;
                }
            }
            function populateList() {
                var list = [];
                angular.forEach(vm.fundList, function(fund) {
                    list.push({
                        id  : fund.id,
                        name: fund.name
                    });
                });
                vm.fundList = list;
            }
            function error() {
                vm.getError = true;
            }
        }

        // CLICKED Expenditure
        $scope.clicked = function(expenditure) {
            var index = vm.expenditureList.indexOf(expenditure);
            if (index !== -1) {
                store.set('expenditure', expenditure);
                return true;
            }
            return false;
        };

        // CLICKED Checkbox
        $scope.clickedCheckbox = function(expenditure) {
            if (expenditure.selected) {
                vm.selected = true;
            } else {
                var isSelected = false;
                angular.forEach(vm.expenditureList, function(e) {
                    if (e.selected) {
                        isSelected = true;
                    }
                });
                vm.selected = isSelected;
            }
        };

        // ADD functions
        $scope.addModal = function() {
            vm.expenditure      = {};
            vm.expenditure.date = new Date();
            $scope.addForm.$setPristine();
            $('#add-modal').modal('show');
        };
        $scope.add = function() {
            var btn = $('#add-button').button('loading');

            if (vm.expenditure.question == 1) {
                vm.expenditure.vendor = vm.expenditure.subcontractor.name;
            }

            addExpenditure()
                .then(success)
                .catch(error);

            function addExpenditure() {
                return expenditureService.create(vm.expenditure);
            }
            function success() {
                $('#add-modal').modal('hide');
                btn.button('reset');
                updateExpenditures();
            }
            function error() {
                $scope.addForm.$invalid = true;
                btn.button('reset');
            }
        };

        // DELETE MANY functions
        $scope.deleteManyModal = function() {
            if (!$('#delete-many-button1').hasClass('disabled')) {
                vm.deleteManyError = false;
                $('#delete-many-modal').modal('show');
            }
        };
        $scope.delete = function() {
            var btn = $('#delete-many-button2').button('loading');

            angular.forEach(vm.expenditureList, function(expenditure) {
                if (expenditure.selected) {
                    deleteExpenditure(expenditure.id)
                        .then(success)
                        .catch(error);

                    // This needs work
                    var index = vm.expenditureList.indexOf(expenditure);
                    if (index !== -1) {
                        vm.expenditureList.splice(index, 1);
                    }
                }
            });

            function deleteExpenditure(expenditureId) {
                return expenditureService.remove(expenditureId);
            }
            function success() {
                $('#delete-many-modal').modal('hide');
                btn.button('reset');
                vm.selected = false;
            }
            function error() {
                vm.deleteManyError = true;
                btn.button('reset');
            }
        };

        // DELETE functions
        $scope.deleteModal = function() {
            vm.deleteError = false;
            $('#delete-modal').modal('show');
        };
        $scope.delete = function() {
            var btn = $('#delete-button').button('loading');

            deleteExpenditure()
                .then(success)
                .catch(error);

            function deleteExpenditure() {
                return expenditureService.remove(store.get('expenditure').id);
            }
            function success() {
                $('#delete-modal').modal('hide');
                btn.button('reset');

                // This needs work
                var index = vm.expenditureList.indexOf(store.get('expenditure'));
                if (index !== -1) {
                    vm.expenditureList.splice(index, 1);
                }
            }
            function error() {
                vm.deleteError = true;
                btn.button('reset');
            }
        };

        // UPDATE functions
        $scope.updateModal = function() {
            vm.updated        = {};
            vm.updated.date   = new Date(store.get('expenditure').date);
            vm.updated.vendor = store.get('expenditure').vendor;
            vm.updated.item   = {
                id  : store.get('expenditure').items.id,
                name: store.get('expenditure').items.name,
                category: {
                    id  : store.get('expenditure').categories.id,
                    name: store.get('expenditure').categories.name,
                }
            };
            vm.updated.notes = store.get('expenditure').notes;
            vm.updated.cost = store.get('expenditure').cost;
            vm.updated.fund = {
                id  : store.get('expenditure').funds.id,
                name: store.get('expenditure').funds.name
            };
            $scope.updateForm.$setPristine();
            $('#update-modal').modal('show');
        };
        $scope.update = function() {
            var btn = $('#update-button').button('loading');

            updateExpenditure()
                .then(success)
                .catch(error);

            function updateExpenditure() {
                return expenditureService.update(vm.updated);
            }
            function success() {
                $('#update-modal').modal('hide');
                btn.button('reset');
                updateExpenditures();
            }
            function error() {
                $scope.updateForm.$invalid = true;
                btn.button('reset');
            }
        };
    }
})();

(function() {
    'use strict';

    angular
        .module('app.projects.expenditures')
        .config(route);

    route.$inject = ['$stateProvider'];

    function route($stateProvider) {
        $stateProvider.state('expenditures', {
            url: '/projects/expenditures',
            resolve: {
                User: ["userService", "$q", function(userService, $q) {
                    return userService.retrieve()
                        .then(responseHandler)
                        .catch(errorHandler);

                    function responseHandler(response) {
                        return response.data;
                    }
                    function errorHandler(response) {
                        return $q.reject(response.data);
                    }
                }]
            },
            views: {
                'nav': {
                    templateUrl: 'www/templates/nav2.html',
                    controller: ["$scope", "User", function($scope, User) {
                        $scope.username = User.username;
                    }]
                },
                'body': {
                    templateUrl:  'www/templates/expenditures.html',
                    controller:   'ExpendituresController',
                    controllerAs: 'vm'
                }
            },
            data: {
                requiresLogin: true
            }
        });
    }
})();

(function() {
    'use strict';

    angular
        .module('app.projects.funds')
        .controller('FundsController', FundsController);

    FundsController.$inject = ['$scope', 'store', 'fundService', 'drawService'];

    function FundsController($scope, store, fundService, drawService) {
        var vm = this;
        vm.project = store.get('project');
        updateFunds();

        function updateFunds() {
            return getFunds()
                .then(updateTable)
                .catch(error);

            function getFunds() {
                return fundService.retrieveList()
                    .then(success);

                function success(response) {
                    vm.fundList = response.data.objects;
                    return vm.fundList;
                }
            }
            function updateTable() {
                angular.forEach(vm.fundList, function(fund) {
                    var totalExpenditure = 0;
                    var totalDraw        = 0;
                    angular.forEach(fund.expenditures, function(expenditure) {
                        totalExpenditure += expenditure.cost;
                    });
                    angular.forEach(fund.draws, function(draw) {
                        totalDraw += draw.amount;
                    });
                    fund.totalExpenditure = totalExpenditure;
                    fund.totalDraw        = totalDraw;
                    fund.spent            = Math.round(totalExpenditure / fund.amount * 100);
                    fund.left             = Math.round((fund.amount - totalExpenditure) / fund.amount * 100);
                    fund.drawReceived     = Math.round(totalDraw / fund.amount * 100);
                    fund.drawLeft         = Math.round((fund.amount - totalDraw) / fund.amount * 100);
                });
            }
            function error(response) {
                vm.errorMsgGet = true;
            }
        }

        $scope.clickedFund = function(fund) {
            var index = vm.fundList.indexOf(fund);
            if (index !== -1) {
                store.set('fund', fund);
                return true;
            }
            return false;
        };
        $scope.clickedDraw = function(draw) {
            var index = store.get('fund').draws.indexOf(draw);
            if (index !== -1) {
                store.set('draw', draw);
                return true;
            }
            return false;
        };
        $scope.clickedAllCheckbox = function() {
            angular.forEach(store.get('fund').draws, function(draw) {
                draw.selected = store.get('fund').checkboxAll;
                store.get('fund').selected = draw.selected;
            });
        };
        $scope.clickedSingleCheckbox = function(draw) {
            if (draw.selected) {
                store.get('fund').selected = true;
            } else {
                var isSelected = false;
                angular.forEach(store.get('fund').draws, function(d) {
                    if (d.selected) {
                        isSelected = true;
                    }
                });
                store.get('fund').selected = isSelected;
            }
        };

        $scope.showAddFundModal = function() {
            vm.fund         = {};
            vm.loanQuestion = [{ value: true, name: 'Yes' }, { value: false, name: 'No' }];
            $scope.addFundForm.$setPristine();
            $('#add-fund-modal').modal('show');
        };
        $scope.addFund = function() {
            var btn = $('#add-fund-button').button('loading');

            addFund()
                .then(addSuccess)
                .catch(error);

            function addFund() {
                return fundService.create(vm.fund);
            }
            function addSuccess(response) {
                $('#add-fund-modal').modal('hide');
                btn.button('reset');
                updateFunds();
            }
            function error(response) {
                $scope.addFundForm.$invalid = true;
                btn.button('reset');
            }
        };

        $scope.showDeleteFundModal = function() {
            vm.errorMsgDelete = false;
            $('#delete-fund-modal').modal('show');
        };
        $scope.deleteFund = function() {
            var btn = $('#delete-fund-button').button('loading');

            if (store.get('fund').draws === 0) {
                deleteFund()
                    .then(deleteSuccess)
                    .catch(error);
            } else {
                deleteDraws()
                    .then(deleteFund)
                    .then(deleteSuccess)
                    .catch(error);
            }

            function deleteDraws() {
                return drawService.removeByFund();
            }
            function deleteFund() {
                return fundService.remove();
            }
            function deleteSuccess(response) {
                $('#delete-fund-modal').modal('hide');
                btn.button('reset');
                updateFunds();
            }
            function error(response) {
                vm.errorMsgDelete = true;
                btn.button('reset');
            }
        };

        $scope.showEditFundModal = function() {
            vm.updatedFund        = {};
            vm.updatedFund.name   = store.get('fund').name;
            vm.updatedFund.amount = store.get('fund').amount;
            $scope.editFundForm.$setPristine();
            $('#edit-fund-modal').modal('show');
        };
        $scope.updateFund = function() {
            var btn = $('#update-fund-button').button('loading');

            updateFund()
                .then(updateSuccess)
                .catch(error);

            function updateFund() {
                return fundService.update(vm.updatedFund);
            }
            function updateSuccess(response) {
                $('#edit-fund-modal').modal('hide');
                btn.button('reset');
                updateFunds();
            }
            function error(response) {
                $scope.editFundForm.$invalid = true;
                btn.button('reset');
            }
        };

        $scope.showAddDrawModal = function() {
            vm.draw      = {};
            vm.draw.date = new Date();
            $scope.addDrawForm.$setPristine();
            $('#add-draw-modal').modal('show');
        };
        $scope.addDraw = function() {
            var btn = $('#add-draw-button').button('loading');

            addDraw()
                .then(addSuccess)
                .catch(error);

            function addDraw() {
                return drawService.create(vm.draw);
            }
            function addSuccess(response) {
                $('#add-draw-modal').modal('hide');
                btn.button('reset');
                updateFunds();
            }
            function error(response) {
                $scope.addDrawForm.$invalid = true;
                btn.button('reset');
            }
        };

        $scope.showDeleteDrawsModal = function() {
            if (store.get('fund').selected) {
                vm.errorMsgDeleteDraws = false;
                $('#delete-draws-modal').modal('show');
            }
        };
        $scope.deleteDraws = function() {
            var btn = $('#delete-draw-button').button('loading');

            angular.forEach(store.get('fund').draws, function(draw) {
                if (draw.selected) {
                    deleteDraw(draw.id)
                        .then(deleteSuccess)
                        .catch(error);
                }
            });

            function deleteDraw(draw_id) {
                return drawService.remove(draw_id);
            }
            function deleteSuccess(response) {
                $('#delete-draws-modal').modal('hide');
                btn.button('reset');
                updateFunds();
            }
            function error(response) {
                vm.errorMsgDeleteDraws = true;
                btn.button('reset');
            }
        };

        $scope.showEditDrawModal = function() {
            vm.updatedDraw        = {};
            vm.updatedDraw.date   = new Date(store.get('draw').date);
            vm.updatedDraw.amount = store.get('draw').amount;
            $scope.editDrawForm.$setPristine();
            $('#edit-draw-modal').modal('show');
        };
        $scope.updateDraw = function() {
            var btn = $('#update-draw-button').button('loading');

            updateDraw()
                .then(updateSuccess)
                .catch(error);

            function updateDraw() {
                return drawService.update(vm.updatedDraw);
            }
            function updateSuccess(response) {
                $('#edit-draw-modal').modal('hide');
                btn.button('reset');
                updateFunds();
            }
            function error(response) {
                $scope.editDrawForm.$invalid = true;
                btn.button('reset');
            }
        };
    }
})();

(function() {
    'use strict';

    angular
        .module('app.projects.funds')
        .config(route);

    route.$inject = ['$stateProvider'];

    function route($stateProvider) {
        $stateProvider.state('funds', {
            url: '/projects/funds',
            resolve: {
                User: ["userService", "$q", function(userService, $q) {
                    return userService.retrieve()
                        .then(responseHandler)
                        .catch(errorHandler);

                    function responseHandler(response) {
                        return response.data;
                    }
                    function errorHandler(response) {
                        return $q.reject(response.data);
                    }
                }]
            },
            views: {
                'nav': {
                    templateUrl: 'www/templates/nav2.html',
                    controller: ["$scope", "User", function($scope, User) {
                        $scope.username = User.username;
                    }]
                },
                'body': {
                    templateUrl:  'www/templates/funds.html',
                    controller:   'FundsController',
                    controllerAs: 'vm'
                }
            },
            data: {
                requiresLogin: true
            }
        });
    }
})();

(function() {
    'use strict';

    angular
        .module('app.home')
        .controller('HomeController', HomeController);

    HomeController.$inject = ['store'];

    function HomeController(store) {
        var vm = this;
        store.remove('jwt');
    }
})();

(function() {
    'use strict';

    angular
        .module('app.home')
        .config(route);

    route.$inject = ['$stateProvider'];

    function route($stateProvider) {
        $stateProvider.state('home', {
            url: '/',
            views: {
                'nav': {
                    templateUrl: 'www/templates/nav1.html'
                },
                'body': {
                    templateUrl:  'www/templates/home.html',
                    controller:   'HomeController',
                    controllerAs: 'vm'
                }
            }
        });
    }
})();

(function() {
    'use strict';

    angular
        .module('app.login')
        .controller('LoginController', LoginController);

    LoginController.$inject = ['$scope', 'store', '$state', 'authService'];

    function LoginController($scope, store, $state, authService) {
        var vm = this;
        store.remove('jwt');

        $scope.logIn = function() {
            var btn = $('#login-button').button('loading');

            authenticateUser()
                .then(goProjects)
                .catch(error);

            function authenticateUser() {
                return authService.authenticate(vm.username, vm.password);
            }
            function goProjects() {
                $state.go('projects');
            }
            function error() {
                $scope.loginForm.$invalid = true;
                vm.password = '';
                btn.button('reset');
            }
        };
    }
})();

(function() {
    'use strict';

    angular
        .module('app.login')
        .config(route);

    route.$inject = ['$stateProvider'];

    function route($stateProvider) {
        $stateProvider.state('login', {
            url: '/login',
            views: {
                'nav': {
                    templateUrl: 'www/templates/nav1.html'
                },
                'body': {
                    templateUrl:  'www/templates/login.html',
                    controller:   'LoginController',
                    controllerAs: 'vm'
                }
            }
        });
    }
})();

(function() {
    'use strict';

    angular
        .module('app.projects.overview')
        .controller('OverviewController', OverviewController);

    OverviewController.$inject = ['store', 'chartService', 'categoryService', 'fundService'];

    function OverviewController(store, chartService, categoryService, fundService) {
        var vm = this;
        vm.project = store.get('project');
        var options = chartService.setPieChartOptions();
        updateCategories();
        updateFunds();

        function updateCategories() {
            return getCategories()
                .then(populateProgressBars)
                .then(populatePieChart)
                .then(populateTable)
                .catch(error);

            function getCategories() {
                return categoryService.retrieveList()
                    .then(success);

                    function success(response) {
                        vm.categoryList = response.data.objects;
                        return vm.categoryList;
                    }
            }
            function populateProgressBars() {
                angular.forEach(vm.categoryList, function(category) {
                    var totalExpenditure = 0;
                    var totalBudget = 0;
                    angular.forEach(category.expenditures, function(expenditure) {
                        totalExpenditure += expenditure.cost;
                    });
                    angular.forEach(category.items, function(item) {
                        totalBudget += item.actual;
                    });
                    category.totalExpenditure = totalExpenditure;
                    category.totalBudget = totalBudget;

                    if (totalBudget === 0 && totalBudget < totalExpenditure) {
                        category.spent = 100;
                        category.left  = 0;
                    } else {
                        category.spent = Math.round(totalExpenditure / totalBudget * 100);
                        category.left  = Math.round((totalBudget - totalExpenditure) / totalBudget * 100);
                    }
                });
            }
            function populatePieChart() {
                options.series[0].data = [];

                if (vm.categoryList.length === 0) {
                    options.series[0].data.push({ name: 'No Data', y: 0.01 });
                } else {
                    angular.forEach(vm.categoryList, function(category) {
                        if (category.items.length !== 0) {
                            var categoryTotal = 0;
                            angular.forEach(category.items, function(item) {
                                categoryTotal += item.actual;
                            });
                            options.series[0].data.push({ name: category.name, y: categoryTotal });
                        }
                    });
                }
                $('#piechart-container').highcharts(options);
            }
            function populateTable() {
                var grandTotalEstimated   = 0;
                var grandTotalActual      = 0;
                var grandTotalExpenditure = 0;

                angular.forEach(vm.categoryList, function(category) {
                    var totalEstimated   = 0;
                    var totalActual      = 0;
                    var totalExpenditure = 0;
                    angular.forEach(category.items, function(item) {
                        totalEstimated += item.estimated;
                        totalActual    += item.actual;
                    });
                    angular.forEach(category.expenditures, function(expenditure) {
                        totalExpenditure += expenditure.cost;
                    });
                    category.totalEstimated   = totalEstimated;
                    category.totalActual      = totalActual;
                    category.totalExpenditure = totalExpenditure;
                    grandTotalEstimated   += totalEstimated;
                    grandTotalActual      += totalActual;
                    grandTotalExpenditure += totalExpenditure;

                    if (totalExpenditure >= totalActual) {
                        category.paid   = 100;
                        category.unpaid = 0;
                    } else {
                        category.paid   = Math.round(totalExpenditure / totalActual * 100);
                        category.unpaid = totalActual - totalExpenditure;
                    }
                });
                vm.grandTotalEstimated   = grandTotalEstimated;
                vm.grandTotalActual      = grandTotalActual;
                vm.grandTotalExpenditure = grandTotalExpenditure;
                vm.grandTotalSpent = Math.round(grandTotalExpenditure / grandTotalActual * 100);
                vm.grandTotalLeft  = Math.round((grandTotalActual - grandTotalExpenditure) / grandTotalActual * 100);
            }
        }

        function updateFunds() {
            return getFunds()
                .then(populateProgressBars)
                .catch(error);

            function getFunds() {
                return fundService.retrieveList()
                    .then(success);

                    function success(response) {
                        vm.fundList = response.data.objects;
                        return vm.fundList;
                    }
            }
            function populateProgressBars() {
                angular.forEach(vm.fundList, function(fund) {
                    var totalExpenditure = 0;
                    var totalDraw        = 0;
                    angular.forEach(fund.expenditures, function(expenditure) {
                        totalExpenditure += expenditure.cost;
                    });
                    angular.forEach(fund.draws, function(draw) {
                        totalDraw += draw.amount;
                    });
                    fund.totalExpenditure = totalExpenditure;
                    fund.totalDraw        = totalDraw;
                    fund.spent            = Math.round(totalExpenditure / fund.amount * 100);
                    fund.left             = Math.round((fund.amount - totalExpenditure) / fund.amount * 100);
                    fund.drawReceived     = Math.round(totalDraw / fund.amount * 100);
                    fund.drawLeft         = Math.round((fund.amount - totalDraw) / fund.amount * 100);
                });
            }
        }

        function error() {
            vm.getError = true;
        }
    }
})();

(function() {
    'use strict';

    updateUser.$inject = ["userService", "$q"];
    NavController.$inject = ["User"];
    angular
        .module('app.projects.overview')
        .config(route);

    route.$inject = ['$stateProvider'];

    function route($stateProvider) {
        $stateProvider.state('overview', {
            url: '/projects/overview',
            resolve: {
                User: updateUser
            },
            views: {
                'nav': {
                    templateUrl:  'www/templates/nav2.html',
                    controller:   NavController,
                    controllerAs: 'vm'
                },
                'body': {
                    templateUrl:  'www/templates/overview.html',
                    controller:   'OverviewController',
                    controllerAs: 'vm'
                }
            },
            data: {
                requiresLogin: true
            }
        });
    }

    function updateUser(userService, $q) {
        return getUser()
            .then(success)
            .catch(error);

        function getUser() {
            return userService.retrieve();
        }
        function success(response) {
            return $q.resolve(response.data);
        }
        function error(response) {
            return $q.reject(response);
        }
    }

    function NavController(User) {
        var vm = this;
        vm.username = User.username;
    }
})();

(function() {
    'use strict';

    angular
        .module('app.projects')
        .controller('ProjectsController', ProjectsController);

    ProjectsController.$inject = ['$scope', 'store', 'projectService', 'utilityService'];

    function ProjectsController($scope, store, projectService, utilityService) {
        var vm = this;
        updateProjects();

        // GET function
        function updateProjects() {
            return getProjects()
                .then(success)
                .catch(error);

            function getProjects() {
                return projectService.retrieveList();
            }
            function success(response) {
                vm.projectList = response.data.objects;
                return vm.projectList;
            }
            function error(response) {
                vm.getError = true;
            }
        }

        // CLICKED function
        $scope.clicked = function(project) {
            var index = vm.projectList.indexOf(project);
            if (index !== -1) {
                store.set('project', project);
                return true;
            }
            return false;
        };

        // ADD functions
        $scope.addModal = function() {
            vm.project = {};
            $scope.addForm.$setPristine();
            $('#add-modal').modal('show');
        };
        $scope.add = function() {
            var btn = $('#add-button').button('loading');

            if ($('#project-file').length && $('#project-file')[0].files[0]) {
                parseFile()
                    .then(success)
                    .catch(error);
            } else {
                createProject()
                    .then(success)
                    .catch(error);
            }

            function parseFile() {
                var file = $('#project-file')[0].files[0];
                return utilityService.parseUbuilditFile(vm.project, file);
            }
            function createProject() {
                return projectService.create(vm.project);
            }
            function success(response) {
                $('#add-modal').modal('hide');
                btn.button('reset');
                updateProjects();
            }
            function error(response) {
                $scope.addForm.$invalid = true;
                btn.button('reset');
            }
        };

        // DELETE functions
        $scope.deleteModal = function(project) {
            vm.deleteError = false;
            vm.deleted = project;
            $('#delete-modal').modal('show');
        };
        $scope.delete = function() {
            var btn = $('#delete-button').button('loading');

            deleteProject()
                .then(success)
                .catch(error);

            function deleteProject() {
                return projectService.remove(vm.deleted);
            }
            function success(response) {
                $('#delete-modal').modal('hide');
                btn.button('reset');
                updateProjects();
            }
            function error(response) {
                vm.deleteError = true;
                btn.button('reset');
            }
        };

        // UPDATE functions
        $scope.updateModal = function(project) {
            vm.updated         = {};
            vm.updated.id      = project.id;
            vm.updated.name    = project.name;
            vm.updated.address = project.address;
            vm.updated.city    = project.city;
            vm.updated.state   = project.state;
            vm.updated.zipcode = project.zipcode;
            vm.updated.homeSq  = project.home_sq;
            $scope.updateForm.$setPristine();
            $('#update-modal').modal('show');
        };
        $scope.update = function() {
            var btn = $('#update-button').button('loading');

            updateProject()
                .then(success)
                .catch(error);

            function updateProject() {
                return projectService.update(vm.updated);
            }
            function success() {
                $('#update-modal').modal('hide');
                btn.button('reset');
                updateProjects();
            }
            function error() {
                $scope.updateForm.$invalid = true;
                btn.button('reset');
            }
        };
    }
})();

(function() {
    'use strict';

    updateUser.$inject = ["userService", "$q"];
    NavController.$inject = ["User"];
    angular
        .module('app.projects')
        .config(route);

    route.$inject = ['$stateProvider'];

    function route($stateProvider) {
        $stateProvider.state('projects', {
            url: '/projects',
            resolve: {
                User: updateUser
            },
            views: {
                'nav': {
                    templateUrl:  'www/templates/nav2.html',
                    controller:   NavController,
                    controllerAs: 'vm'
                },
                'body': {
                    templateUrl:  'www/templates/projects.html',
                    controller:   'ProjectsController',
                    controllerAs: 'vm'
                }
            },
            data: {
                requiresLogin: true
            }
        });
    }

    function updateUser(userService, $q) {
        return getUser()
            .then(success)
            .catch(error);

        function getUser() {
            return userService.retrieve();
        }
        function success(response) {
            return $q.resolve(response.data);
        }
        function error(response) {
            return $q.reject(response);
        }
    }

    function NavController(User) {
        var vm = this;
        vm.username = User.username;
    }
})();

(function() {
    'use strict';

    angular
        .module('app.projects.subcontractors')
        .controller('SubcontractorsController', SubcontractorsController);

    SubcontractorsController.$inject = ['$scope', 'store', 'subcontractorService'];

    function SubcontractorsController($scope, store, subcontractorService) {
        var vm = this;
        vm.project = store.get('project');
        updateSubcontractors();

        // GET function
        function updateSubcontractors() {
            return getSubcontractors();

            function getSubcontractors() {
                return subcontractorService.retrieveList()
                    .then(success)
                    .catch(error);

                function success(response) {
                    vm.subcontractorList = response.data.objects;
                    return vm.subcontractorList;
                }
                function error() {
                    vm.getError = true;
                }
            }
        }

        // CLICKED function
        $scope.clickedCheckbox = function(subcontractor) {
            if (subcontractor.selected) {
                vm.selected = true;
            } else {
                var isSelected = false;
                angular.forEach(vm.subcontractorList, function(e) {
                    if (e.selected) {
                        isSelected = true;
                    }
                });
                vm.selected = isSelected;
            }
        };

        // ADD functions
        $scope.addModal = function() {
            vm.subcontractor = {};
            $scope.addForm.$setPristine();
            $('#add-modal').modal('show');
        };
        $scope.add = function() {
            var btn = $('#add-button').button('loading');

            addSubcontractor()
                .then(sucess)
                .catch(error);

            function addSubcontractor() {
                return subcontractorService.create(vm.subcontractor);
            }
            function sucess() {
                $('#add-modal').modal('hide');
                btn.button('reset');
                updateSubcontractors();
            }
            function error() {
                $scope.addForm.$invalid = true;
                btn.button('reset');
            }
        };

        // DELETE MANY functions
        $scope.deleteManyModal = function() {
            if (!$('#delete-many-button1').hasClass('disabled')) {
                vm.deleteManyError = false;
                $('#delete-many-modal').modal('show');
            }
        };
        $scope.deleteMany = function() {
            var btn = $('#delete-many-button2').button('loading');

            angular.forEach(vm.subcontractorList, function(subcontractor) {
                if (subcontractor.selected) {
                    deleteSubcontractor(subcontractor)
                        .then(success)
                        .catch(error);
                }
            });

            function deleteSubcontractor(subcontractorId) {
                return subcontractorService.remove(subcontractorId);
            }
            function success() {
                $('#delete-many-modal').modal('hide');
                btn.button('reset');
                vm.selected = false;
                updateSubcontractors();
            }
            function error() {
                vm.deleteManyError = true;
                btn.button('reset');
            }
        };

        // DELETE functions
        $scope.deleteModal = function(subcontractor) {
            vm.deleteError = false;
            vm.deleted = subcontractor;
            $('#delete-modal').modal('show');
        };
        $scope.delete = function() {
            var btn = $('#delete-button').button('loading');

            deleteSubcontractor()
                .then(success)
                .catch(error);

            function deleteSubcontractor() {
                return subcontractorService.remove(vm.deleted);
            }
            function success() {
                $('#delete-modal').modal('hide');
                btn.button('reset');
                updateSubcontractors();
            }
            function error() {
                vm.deleteError = true;
                btn.button('reset');
            }
        };

        // UPDATE functions
        $scope.updateModal = function(subcontractor) {
            vm.updated               = {};
            vm.updated.id            = subcontractor.id;
            vm.updated.name          = subcontractor.name;
            vm.updated.company       = subcontractor.company;
            vm.updated.contactNumber = subcontractor.contact_number;
            $scope.updateForm.$setPristine();
            $('#update-modal').modal('show');
        };
        $scope.update = function() {
            var btn = $('#update-button').button('loading');

            updateSubcontractor()
                .then(success)
                .catch(error);

            function updateSubcontractor() {
                return subcontractorService.update(vm.updated);
            }
            function success() {
                $('#update-modal').modal('hide');
                btn.button('reset');
                updateSubcontractors();
            }
            function error() {
                $scope.updateForm.$invalid = true;
                btn.button('reset');
            }
        };
    }
})();

(function() {
    'use strict';

    updateUser.$inject = ["userService", "$q"];
    NavController.$inject = ["User"];
    angular
        .module('app.projects.subcontractors')
        .config(route);

    route.$inject = ['$stateProvider'];

    function route($stateProvider) {
        $stateProvider.state('subcontractors', {
            url: '/projects/subcontractors',
            resolve: {
                User: updateUser
            },
            views: {
                'nav': {
                    templateUrl:  'www/templates/nav2.html',
                    controller:   NavController,
                    controllerAs: 'vm'
                },
                'body': {
                    templateUrl:  'www/templates/subcontractors.html',
                    controller:   'SubcontractorsController',
                    controllerAs: 'vm'
                }
            },
            data: {
                requiresLogin: true
            }
        });
    }

    function updateUser(userService, $q) {
        return getUser()
            .then(success)
            .catch(error);

        function getUser() {
            return userService.retrieve();
        }
        function success(response) {
            return $q.resolve(response.data);
        }
        function error(response) {
            return $q.reject(response);
        }
    }

    function NavController(User) {
        var vm = this;
        vm.username = User.username;
    }
})();

(function() {
    'use strict';

    angular
        .module('app.signup')
        .controller('SignupController', SignupController);

    SignupController.$inject = ['$scope', 'store', '$state', 'stripeService', 'authService'];

    function SignupController($scope, store, $state, stripeService, authService) {
        var vm = this;
        vm.plan = 'free';
        store.remove('jwt');

        $scope.signUp = function() {
            var btn = $('#signup-button').button('loading');
            var valid = stripeService.validateCard(vm);

            if (valid) {
                createToken()
                    .then(subscribeUser)
                    .then(authenticateUser)
                    .then(goTutorial)
                    .catch(error);
            } else {
                error();
            }

            function createToken() {
                return stripeService.createCardToken(vm);
            }
            function subscribeUser(response) {
                return stripeService.createSubscription(vm, response.id);
            }
            function authenticateUser() {
                return authService.authenticate(vm.username, vm.password);
            }
            function goTutorial() {
                $state.go('tutorial');
            }
            function error() {
                $scope.signupForm.$invalid = true;
                btn.button('reset');
            }
        };
    }
})();

(function() {
    'use strict';

    angular
        .module('app.signup')
        .config(route);

    route.$inject = ['$stateProvider'];

    function route($stateProvider) {
        $stateProvider.state('signup', {
            url: '/signup',
            views: {
                'nav': {
                    templateUrl: 'www/templates/nav1.html'
                },
                'body': {
                    templateUrl:  'www/templates/signup.html',
                    controller:   'SignupController',
                    controllerAs: 'vm'
                }
            }
        });
    }
})();

(function() {
    'use strict';

    angular
        .module('app.tutorial')
        .controller('TutorialController', TutorialController);

    function TutorialController() {
        var vm = this;
    }
})();

(function() {
    'use strict';

    updateUser.$inject = ["userService", "$q"];
    NavController.$inject = ["User"];
    angular
        .module('app.tutorial')
        .config(route);

    route.$inject = ['$stateProvider'];

    function route($stateProvider) {
        $stateProvider.state('tutorial', {
            url: '/tutorial',
            resolve: {
                User: updateUser
            },
            views: {
                'nav': {
                    templateUrl:  'www/templates/nav2.html',
                    controller:   NavController,
                    controllerAs: 'vm'
                },
                'body': {
                    templateUrl:  'www/templates/tutorial.html',
                    controller:   'TutorialController',
                    controllerAs: 'vm'
                }
            },
            data: {
                requiresLogin: true
            }
        });
    }

    function updateUser(userService, $q) {
        return getUser()
            .then(success)
            .catch(error);

        function getUser() {
            return userService.retrieve();
        }
        function success(response) {
            return $q.resolve(response.data);
        }
        function error(response) {
            return $q.reject(response);
        }
    }

    function NavController(User) {
        var vm = this;
        vm.username = User.username;
    }
})();
